{"version":3,"file":"bridge-mode/io-client.mjs","sources":["webpack://@midscene/web/./src/bridge-mode/io-client.ts"],"sourcesContent":["import { assert } from '@midscene/shared/utils';\nimport { io as ClientIO, type Socket as ClientSocket } from 'socket.io-client';\nimport {\n  type BridgeCallRequest,\n  type BridgeCallResponse,\n  type BridgeConnectedEventPayload,\n  BridgeEvent,\n} from './common';\n\ndeclare const __VERSION__: string;\n\n// ws client, this is where the request is processed\nexport class BridgeClient {\n  private socket: ClientSocket | null = null;\n  public serverVersion: string | null = null;\n  constructor(\n    public endpoint: string,\n    public onBridgeCall: (method: string, args: any[]) => Promise<any>,\n    public onDisconnect?: () => void,\n  ) {}\n\n  async connect() {\n    return new Promise((resolve, reject) => {\n      this.socket = ClientIO(this.endpoint, {\n        reconnection: false,\n        query: {\n          version: __VERSION__,\n        },\n      });\n\n      const timeout = setTimeout(() => {\n        try {\n          this.socket?.offAny();\n          this.socket?.close();\n        } catch (e) {\n          console.warn('got error when offing socket', e);\n        }\n        this.socket = null;\n        reject(new Error('failed to connect to bridge server after timeout'));\n      }, 1 * 1000);\n\n      // on disconnect\n      this.socket.on('disconnect', (reason: string) => {\n        // console.log('bridge-disconnected, reason:', reason);\n        this.socket = null;\n        this.onDisconnect?.();\n      });\n\n      this.socket.on('connect_error', (e: any) => {\n        console.error('bridge-connect-error', e);\n        reject(new Error(e || 'bridge connect error'));\n      });\n\n      this.socket.on(\n        BridgeEvent.Connected,\n        (payload: BridgeConnectedEventPayload) => {\n          clearTimeout(timeout);\n          this.serverVersion = payload?.version || 'unknown';\n          resolve(this.socket);\n        },\n      );\n      this.socket.on(BridgeEvent.Refused, (e: any) => {\n        console.error('bridge-refused', e);\n        try {\n          this.socket?.disconnect();\n        } catch (e) {\n          // console.warn('got error when disconnecting socket', e);\n        }\n        reject(new Error(e || 'bridge refused'));\n      });\n      this.socket.on(BridgeEvent.Call, (call: BridgeCallRequest) => {\n        const id = call.id;\n        assert(typeof id !== 'undefined', 'call id is required');\n        (async () => {\n          let response: any;\n          try {\n            response = await this.onBridgeCall(call.method, call.args);\n          } catch (e: any) {\n            const errorContent = `Error from bridge client when calling, method: ${call.method}, args: ${call.args}, error: ${e?.message || e}\\n${e?.stack || ''}`;\n            console.error(errorContent);\n            return this.socket?.emit(BridgeEvent.CallResponse, {\n              id,\n              error: errorContent,\n            } as BridgeCallResponse);\n          }\n          this.socket?.emit(BridgeEvent.CallResponse, {\n            id,\n            response,\n          } as BridgeCallResponse);\n        })();\n      });\n    });\n  }\n\n  disconnect() {\n    this.socket?.disconnect();\n    this.socket = null;\n  }\n}\n"],"names":["BridgeClient","Promise","resolve","reject","ClientIO","__VERSION__","timeout","setTimeout","_this_socket","_this_socket1","e","console","Error","reason","_this","BridgeEvent","payload","clearTimeout","call","id","assert","response","errorContent","endpoint","onBridgeCall","onDisconnect"],"mappings":"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"}