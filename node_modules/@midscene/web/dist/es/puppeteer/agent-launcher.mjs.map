{"version":3,"file":"puppeteer/agent-launcher.mjs","sources":["webpack://@midscene/web/./src/puppeteer/agent-launcher.ts"],"sourcesContent":["import { readFileSync } from 'node:fs';\nimport { getDebug } from '@midscene/shared/logger';\nimport { assert } from '@midscene/shared/utils';\n\nimport { PuppeteerAgent } from '@/puppeteer/index';\nimport type { MidsceneYamlScriptWebEnv } from '@midscene/core';\nimport { DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT } from '@midscene/shared/constants';\nimport puppeteer, { type Browser } from 'puppeteer';\n\nexport const defaultUA =\n  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36';\nexport const defaultViewportWidth = 1440;\nexport const defaultViewportHeight = 768;\nexport const defaultViewportScale = process.platform === 'darwin' ? 2 : 1;\nexport const defaultWaitForNetworkIdleTimeout =\n  DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT;\n\ninterface FreeFn {\n  name: string;\n  fn: () => void;\n}\n\nconst launcherDebug = getDebug('puppeteer:launcher');\n\nexport async function launchPuppeteerPage(\n  target: MidsceneYamlScriptWebEnv,\n  preference?: {\n    headed?: boolean;\n    keepWindow?: boolean;\n  },\n  browser?: Browser,\n) {\n  assert(target.url, 'url is required');\n  const freeFn: FreeFn[] = [];\n\n  // prepare the environment\n  const ua = target.userAgent || defaultUA;\n  let width = defaultViewportWidth;\n  let preferMaximizedWindow = true;\n  if (target.viewportWidth) {\n    preferMaximizedWindow = false;\n    assert(\n      typeof target.viewportWidth === 'number',\n      'viewportWidth must be a number',\n    );\n    width = Number.parseInt(target.viewportWidth as unknown as string, 10);\n    assert(width > 0, `viewportWidth must be greater than 0, but got ${width}`);\n  }\n  let height = defaultViewportHeight;\n  if (target.viewportHeight) {\n    preferMaximizedWindow = false;\n    assert(\n      typeof target.viewportHeight === 'number',\n      'viewportHeight must be a number',\n    );\n    height = Number.parseInt(target.viewportHeight as unknown as string, 10);\n    assert(\n      height > 0,\n      `viewportHeight must be greater than 0, but got ${height}`,\n    );\n  }\n  let dpr = defaultViewportScale;\n  if (target.viewportScale) {\n    preferMaximizedWindow = false;\n    assert(\n      typeof target.viewportScale === 'number',\n      'viewportScale must be a number',\n    );\n    dpr = Number.parseInt(target.viewportScale as unknown as string, 10);\n    assert(dpr > 0, `viewportScale must be greater than 0, but got ${dpr}`);\n  }\n  const viewportConfig = {\n    width,\n    height,\n    deviceScaleFactor: dpr,\n  };\n\n  const headed = preference?.headed || preference?.keepWindow;\n\n  // only maximize window in headed mode\n  preferMaximizedWindow = preferMaximizedWindow && !!headed;\n\n  // launch the browser\n  if (headed && process.env.CI === '1') {\n    console.warn(\n      'you are probably running headed mode in CI, this will usually fail.',\n    );\n  }\n  // do not use 'no-sandbox' on windows https://www.perplexity.ai/search/how-to-solve-this-with-nodejs-dMHpdCypRa..JA8TkQzbeQ\n  const isWindows = process.platform === 'win32';\n  const args = [\n    ...(isWindows ? [] : ['--no-sandbox', '--disable-setuid-sandbox']),\n    '--disable-features=HttpsFirstBalancedModeAutoEnable',\n    '--disable-features=PasswordLeakDetection',\n    '--disable-save-password-bubble',\n    `--user-agent=\"${ua}\"`,\n    preferMaximizedWindow\n      ? '--start-maximized'\n      : `--window-size=${width},${height + 200}`, // add 200px for the address bar\n  ];\n\n  launcherDebug(\n    'launching browser with viewport, headed',\n    headed,\n    'viewport',\n    viewportConfig,\n    'args',\n    args,\n    'preference',\n    preference,\n  );\n  let browserInstance = browser;\n  if (!browserInstance) {\n    browserInstance = await puppeteer.launch({\n      headless: !preference?.headed,\n      defaultViewport: viewportConfig,\n      args,\n      acceptInsecureCerts: target.acceptInsecureCerts,\n    });\n    freeFn.push({\n      name: 'puppeteer_browser',\n      fn: () => {\n        if (!preference?.keepWindow) {\n          if (isWindows) {\n            setTimeout(() => {\n              browserInstance?.close();\n            }, 800);\n          } else {\n            browserInstance?.close();\n          }\n        }\n      },\n    });\n  }\n  const page = await browserInstance.newPage();\n  // await page.setUserAgent(ua);\n  // await page.setViewport(viewportConfig);\n\n  if (target.cookie) {\n    const cookieFileContent = readFileSync(target.cookie, 'utf-8');\n    await browserInstance.setCookie(...JSON.parse(cookieFileContent));\n  }\n\n  if (ua) {\n    await page.setUserAgent(ua);\n  }\n\n  if (viewportConfig) {\n    await page.setViewport(viewportConfig);\n  }\n\n  const waitForNetworkIdleTimeout =\n    typeof target.waitForNetworkIdle?.timeout === 'number'\n      ? target.waitForNetworkIdle.timeout\n      : defaultWaitForNetworkIdleTimeout;\n\n  try {\n    launcherDebug('goto', target.url);\n    await page.goto(target.url);\n    if (waitForNetworkIdleTimeout > 0) {\n      launcherDebug('waitForNetworkIdle', waitForNetworkIdleTimeout);\n      await page.waitForNetworkIdle({\n        timeout: waitForNetworkIdleTimeout,\n      });\n    }\n  } catch (e) {\n    if (\n      typeof target.waitForNetworkIdle?.continueOnNetworkIdleError ===\n        'boolean' &&\n      !target.waitForNetworkIdle?.continueOnNetworkIdleError\n    ) {\n      const newError = new Error(`failed to wait for network idle: ${e}`, {\n        cause: e,\n      });\n      throw newError;\n    }\n    const newMessage = `failed to wait for network idle after ${waitForNetworkIdleTimeout}ms, but the script will continue.`;\n    console.warn(newMessage);\n  }\n\n  return { page, freeFn };\n}\n\nexport async function puppeteerAgentForTarget(\n  target: MidsceneYamlScriptWebEnv,\n  preference?: {\n    headed?: boolean;\n    keepWindow?: boolean;\n    testId?: string;\n    cacheId?: string;\n  },\n  browser?: Browser,\n) {\n  const { page, freeFn } = await launchPuppeteerPage(\n    target,\n    preference,\n    browser,\n  );\n\n  // prepare Midscene agent\n  const agent = new PuppeteerAgent(page, {\n    autoPrintReportMsg: false,\n    testId: preference?.testId,\n    cacheId: preference?.cacheId,\n    aiActionContext: target.aiActionContext,\n    forceSameTabNavigation:\n      typeof target.forceSameTabNavigation !== 'undefined'\n        ? target.forceSameTabNavigation\n        : true, // true for default in yaml script\n  });\n\n  freeFn.push({\n    name: 'midscene_puppeteer_agent',\n    fn: () => agent.destroy(),\n  });\n\n  return { agent, freeFn };\n}\n"],"names":["defaultUA","defaultViewportWidth","defaultViewportHeight","defaultViewportScale","process","defaultWaitForNetworkIdleTimeout","DEFAULT_WAIT_FOR_NETWORK_IDLE_TIMEOUT","launcherDebug","getDebug","launchPuppeteerPage","target","preference","browser","_target_waitForNetworkIdle","assert","freeFn","ua","width","preferMaximizedWindow","Number","height","dpr","viewportConfig","headed","console","isWindows","args","browserInstance","puppeteer","setTimeout","page","cookieFileContent","readFileSync","JSON","waitForNetworkIdleTimeout","e","_target_waitForNetworkIdle1","_target_waitForNetworkIdle2","newError","Error","newMessage","puppeteerAgentForTarget","agent","PuppeteerAgent"],"mappings":"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"}